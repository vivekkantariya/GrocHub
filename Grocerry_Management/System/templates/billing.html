<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Billing Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #344e41;
            margin: 0;
        }

        #container {
            margin: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-size: 22px;
            color: white;
        }

        input[type="tel"],
        input[type="text"],
        textarea {
            width: 40%;
            padding: 6px 15px;
            margin-bottom: 20px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #ffffff26;
            font-size: 18px;
        }

        textarea {
            resize: vertical;
        }

        h2 {
            font-size: 32px;
            color: white;
            font-family: 'Raleway', sans-serif;
            background: #608d6f;
            padding: 10px 16px;
            border-radius: 10px;
        }

        table {
            width: 100%;
            background: white;
            border-collapse: collapse;
            margin-top: 20px;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 30px;
        }

        thead {
            background-color: #f2f2f2;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }

        tbody tr:nth-child(even) {
            background-color: #5881571d;
        }

        tbody tr:hover {
            background-color: #58815741;
        }

        label#grandTotal {
            display: block;
            margin-bottom: 5px;
            color: white;
            font-size: 22px;
            font-family: 'Raleway', sans-serif;
            margin-bottom: 20px;
        }

        button {
            background-color: #97bb97;
            color: black;
            font-size: 16px;
            padding: 9px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
        }

        button:hover {
            background-color: #608d6f;
        }
    </style>
</head>

<body>
    <div id="container">

        <h2>Billing Information</h2>

        <form id="billingForm">
            {% csrf_token %}

            <label for="customer_name">Customer Name:</label>
            <input type="text" id="customer_name" name="customer_name" required>

            <label for="customer_email">Email Address:</label>
            <input type="text" id="customer_email" name="customer_email" required>

            <label for="phoneNumber">Phone Number:</label>
            <input type="tel" id="phoneNumber" name="phoneNumber" required>

            <label for="address">Address:</label>
            <textarea id="address" name="address" rows="4" required></textarea>

            <hr>

            <h2>Product Details</h2>

            <!-- Inside the form in your billing.html page -->
            <label for="products">Product Name:</label>
            <input type="text" id="products" name="products" required autocomplete="off">
            <div id="productSuggestions"></div>

            <label for="quantity">Quantity:</label>
            <input type="number" id="quantity" name="quantity" required>

            <button type="button" id="addProductBtn">Add Product</button>

            <table id="productTable">
                <thead>
                    <tr>
                        <th>Product Name</th>
                        <th>Quantity</th>
                        <th>Price</th>
                        <th>Subtotal</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

            <label id="grandTotal">Grand Total: $0.00</label>

            <button type="submit">Generate Bill</button>
        </form>
        <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
        <script>

            document.addEventListener('DOMContentLoaded', function () {
                // Add event listener to the "Add Product" button
                document.getElementById('addProductBtn').addEventListener('click', addProduct);

                // Add event listener to the form submission
                document.getElementById('billingForm').addEventListener('submit', generateBill);

                // Function to add a product to the table
                function addProduct() {
                    var productName = document.getElementById('products').value;
                    var quantity = document.getElementById('quantity').value;

                    // Validate input
                    if (productName.trim() === '' || quantity <= 0) {
                        alert('Please enter valid product details.');
                        return;
                    }

                    $.ajax({
                        url: '/get_product_suggestions/',
                        data: { search: productName },
                        dataType: 'json',
                        success: function (data) {
                            if (data.length > 0) {
                                // Assuming the server returns product details like price
                                var productDetails = data[0];
                                var quantity = document.getElementById('quantity').value || 1;

                                // Add the product to the table
                                var tableBody = document.getElementById('productTable').getElementsByTagName('tbody')[0];
                                var newRow = tableBody.insertRow(tableBody.rows.length);

                                var cell1 = newRow.insertCell(0);
                                var cell2 = newRow.insertCell(1);
                                var cell3 = newRow.insertCell(2);
                                var cell4 = newRow.insertCell(3);
                                var cell5 = newRow.insertCell(4);

                                cell1.innerHTML = productDetails.name;
                                cell2.innerHTML = quantity;
                                cell3.innerHTML = '$' + productDetails.price.toFixed(2);
                                cell4.innerHTML = '$' + (quantity * productDetails.price).toFixed(2);
                                cell5.innerHTML = '<button type="button" onclick="removeProduct(this)">Remove</button>';

                                // Update grand total
                                updateGrandTotal();

                                var formData = new FormData(document.getElementById('billingForm'));
                                formData.append('products', productName);
                                formData.append('quantity', quantity);

                            } else {
                                alert('Product not found.');
                            }
                        }
                    });
                }

                // Function to remove a product from the table
                window.removeProduct = function (button) {
                    var row = button.parentNode.parentNode;
                    row.parentNode.removeChild(row);

                    // Update grand total
                    updateGrandTotal();
                };

                // Function to update the grand total
                function updateGrandTotal() {
                    var total = 0;
                    var table = document.getElementById('productTable');
                    for (var i = 1; i < table.rows.length; i++) {
                        total += parseFloat(table.rows[i].cells[3].innerHTML.replace('$', ''));
                    }

                    document.getElementById('grandTotal').innerHTML = 'Grand Total: $' + total.toFixed(2);
                }

                // Function to handle form submission
                // Function to handle form submission
                function generateBill(event) {
                    event.preventDefault();

                    // Create FormData including CSRF token
                    var formData = new FormData(document.getElementById('billingForm'));
                    formData.append('csrfmiddlewaretoken', $('input[name="csrfmiddlewaretoken"]').val());

                    var productTable = document.getElementById('productTable');
                    for (var i = 1; i < productTable.rows.length; i++) {
                        formData.append('products', productTable.rows[i].cells[0].innerHTML.trim());
                        formData.append('quantity', productTable.rows[i].cells[1].innerHTML.trim());
                        // Add other product-related data if needed
                    }

                    // Send the form data to the server
                    $.ajax({
                        url: '/generate_bill/',  // Update the URL to your Django view
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function (data) {
                            if (data.success) {
                                sendBillByEmail(data.customer_email, data.bill_content);
                            } else {
                                alert('Bill Sent Successfully!');
                                console.error('Error details:', data.error);
                            }
                        },
                        error: function (xhr, textStatus, errorThrown) {
                            alert('Error generating the bill. Please check the console for details.');
                            console.error('XHR:', xhr);
                            console.error('Status:', textStatus);
                            console.error('Error thrown:', errorThrown);
                            console.log("FormData:", formData);
                        }
                    });
                }

                function sendBillByEmail(customerEmail, billContent) {
                    var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();

                    // Send an email using your Django view for sending emails
                    $.ajax({
                        url: '/send_bill_email/',  // Update the URL to your Django email view
                        type: 'POST',
                        headers: { 'X-CSRFToken': csrfToken },  // Include the CSRF token in the headers
                        data: {
                            'customer_email': customerEmail,
                            'bill_content': billContent
                        },
                        success: function (emailData) {
                            console.log('Email Data:', emailData);  // Log the response
                            if (emailData.success) {
                                alert('Bill sent successfully!');
                            } else {
                                alert('Error sending the bill. Please check the console for details.');
                                console.error('Email error details:', emailData.error);
                            }
                        },

                        error: function (xhr, textStatus, errorThrown) {
                            alert('Error sending the bill. Please check the console for details.');
                            console.error('XHR:', xhr);
                            console.error('Status:', textStatus);
                            console.error('Error thrown:', errorThrown);
                        }
                    });
                }
            });
        </script>
</body>

</html>